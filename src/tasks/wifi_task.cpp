/**
 * @file wifi_task.cpp
 * @brief Implements the background task for WiFi, time sync, and E-Paper display.
 *
 * This file contains two tasks:
 * 1. taskWiFi: An event-driven task that handles WiFi connection, provisioning,
 * and NTP time synchronization.
 * 2. task_epd: A simple task that waits for signals to update the E-Paper display.
 * Both tasks use the shared AppContext for resources.
 */

#include "wifi_task.h"
#include "../AppContext.h"
#include "../certs.h"
#include <WiFiClientSecure.h>
#include <WiFiProvisioner.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "time.h"
#include <stdlib.h> // Required for setenv
#include <TzDbLookup.h>
#include <sys/time.h>

// --- Helper Function Prototypes ---
static bool initializeFromRtc(AppContext *context);
static bool getTimezoneAndSync(AppContext *context);

void taskWiFi(void *pvParameters)
{
    Serial.println("WiFi Task started.");
    auto *context = static_cast<AppContext *>(pvParameters);

    // Attempt to initialize system time from the hardware RTC first.
    // This provides an immediate time display while WiFi connects in the background.
    initializeFromRtc(context);

    NetworkEvent_t rxevent;
    for (;;)
    {
        // Block and wait for a network event to occur
        if (xQueueReceive(context->networkEventQueue, &rxevent, portMAX_DELAY))
        {
            switch (rxevent)
            {
            case WIFI_EVENT_DISCONNECTED:
            {
                Serial.println("[WiFi Task] Event: Disconnected. Attempting to reconnect...");
                Serial.println("[WiFi Task] Could not connect. Starting provisioning portal.");
                context->display.clearBuffer();
                context->display.setCursor(0, 0);
                context->display.setTextSize(1);
                context->display.setTextColor(EPD_RED);
                context->display.println("Status: Disconnected");
                context->display.setTextColor(EPD_BLACK);
                context->display.println("Attempting Re-Connect...");
                xQueueSend(context->epdQueue, NULL, 0);
                WiFi.begin();
            }
            break;

            case WIFI_BOOT: // Handles initial boot and manual sync requests
            {
                Serial.println("[WiFi Task] Event: Boot or Manual Sync requested.");

                // If already connected, immediately try to sync.
                if (WiFi.status() == WL_CONNECTED)
                {
                    Serial.println("[WiFi Task] Already connected. Proceeding directly to time sync.");
                    getTimezoneAndSync(context);
                    break; // Exit the case
                }

                // If not connected, attempt to connect.
                WiFi.mode(WIFI_STA);
                WiFi.begin();

                unsigned long start = millis();
                while (WiFi.status() != WL_CONNECTED && millis() - start < 10000)
                {
                    vTaskDelay(pdMS_TO_TICKS(500));
                }

                // After trying, if still not connected, start provisioning.
                if (WiFi.status() != WL_CONNECTED)
                {
                    Serial.println("[WiFi Task] Could not connect. Starting provisioning portal.");
                    context->display.clearBuffer();
                    context->display.setCursor(0, 0);
                    context->display.setTextSize(1);
                    context->display.setTextColor(EPD_RED);
                    context->display.println("Status: Configure WiFi");
                    context->display.setTextColor(EPD_BLACK);
                    context->display.printf("Connect to AP:\n%s\n", WIFI_PROV_SSID);
                    context->display.println("and sign into the portal.");
                    xQueueSend(context->epdQueue, NULL, 0);

                    WiFiProvisioner::Config customCfg(
                        WIFI_PROV_SSID,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Access Point Name
                        "Wi this Clock not Fi",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // HTML Page Title
                        "#0989d8",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Theme Color
                        R"rawliteral(<svg id="Icon" svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 width="100%" viewBox="0 0 784 1024" enable-background="new 0 0 784 1024" xml:space="preserve"><path fill="#000000" opacity="1.000000" stroke="none" 	d="M259.937561,609.000000 	C259.937286,646.269287 259.937286,683.038574 259.937286,721.634705 	C217.903320,697.374756 177.167923,673.864319 135.172211,649.626465 	C177.008163,625.443359 217.558563,602.003418 258.108948,578.563416 	C258.691345,578.727417 259.273743,578.891357 259.856140,579.055359 	C259.883362,588.870239 259.910583,598.685120 259.937561,609.000000 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M245.658936,369.394409 	C209.084976,348.235260 172.834885,327.247803 135.247452,305.486023 	C177.131058,281.278534 217.669647,257.848389 259.295349,233.789948 	C259.295349,281.992615 259.295349,328.921143 259.295349,377.085846 	C254.467056,374.358521 250.224930,371.962311 245.658936,369.394409 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M199.822144,439.778076 	C219.538498,428.381012 238.932892,417.157715 259.374634,405.328308 	C259.374634,453.583557 259.374634,500.534912 259.374634,548.849426 	C217.910706,524.893372 177.265976,501.410553 135.202347,477.108002 	C157.561966,464.186920 178.531067,452.069366 199.822144,439.778076 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M499.245789,355.807343 	C470.872925,339.407166 442.815552,323.191711 413.293976,306.130035 	C455.178131,281.947876 495.806274,258.490875 537.496216,234.420822 	C537.496216,282.619415 537.496216,329.528015 537.496216,377.790771 	C524.433228,370.284332 511.997253,363.138214 499.245789,355.807343 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M578.330078,593.602661 	C610.283508,612.100464 641.910583,630.428345 674.773743,649.472595 	C632.986145,673.619141 592.357056,697.096252 550.656494,721.192505 	C550.656494,672.862549 550.656494,625.950806 550.656494,577.762878 	C560.310181,583.294373 569.156982,588.363525 578.330078,593.602661 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M420.256958,159.669495 	C457.739685,181.345459 494.901337,202.845047 533.590027,225.228088 	C491.694489,249.454025 451.083740,272.937073 409.458496,297.006744 	C409.458496,248.806931 409.458496,201.867126 409.458496,154.606995 	C413.777649,155.045990 416.504822,158.054001 420.256958,159.669495 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M550.060181,354.999786 	C550.973755,314.637817 549.838623,274.755676 550.116333,233.263687 	C592.227844,257.577545 632.795044,280.999786 674.823303,305.265594 	C633.088806,329.423096 592.473755,352.932587 550.614868,377.162109 	C549.516541,369.203888 550.323364,362.313141 550.060181,354.999786 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M538.178223,695.999817 	C538.178162,703.091797 538.178162,709.683777 538.178162,718.014404 	C496.116425,693.765015 455.453888,670.322327 413.353577,646.050720 	C455.236023,621.851990 495.875793,598.371277 536.515564,574.890503 	C537.069763,575.099243 537.624023,575.307983 538.178223,575.516663 	C538.178223,615.511108 538.178223,655.505493 538.178223,695.999817 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M458.726440,768.804077 	C442.036499,778.416016 425.662933,787.842407 408.318268,797.827881 	C408.318268,749.663574 408.318268,702.745422 408.318268,654.479675 	C449.706177,678.392456 490.429260,701.921143 532.396606,726.168701 	C507.034149,740.845947 483.038483,754.732239 458.726440,768.804077 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M585.274170,585.796875 	C573.620483,579.047852 562.284424,572.481628 549.555420,565.108582 	C591.459290,540.936707 632.119629,517.482178 673.739014,493.474426 	C673.739014,541.548340 673.739014,588.368164 673.739014,636.731628 	C643.897522,619.549988 614.744629,602.764893 585.274170,585.796875 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M633.153931,453.805786 	C646.818176,461.694458 660.164368,469.403320 674.787415,477.849640 	C632.944275,502.050415 592.301819,525.556824 550.103149,549.963196 	C550.000610,501.564209 551.411560,454.525757 549.871765,407.495148 	C550.433411,407.172913 550.995056,406.850677 551.556702,406.528442 	C578.649780,422.227600 605.742859,437.926788 633.153931,453.805786 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M674.298157,403.000061 	C674.298218,422.788605 674.298218,442.077118 674.298218,463.285217 	C632.297729,439.089966 591.562134,415.623413 549.471863,391.376465 	C591.514526,367.133698 632.189941,343.679291 674.298096,319.398773 	C674.298096,348.119263 674.298096,375.309631 674.298157,403.000061 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M190.653320,523.286743 	C213.694901,536.598755 236.429749,549.711487 260.498291,563.593445 	C218.588196,587.753906 177.959564,611.175598 136.288773,635.198120 	C136.288773,587.002258 136.288773,540.224915 136.288773,492.010925 	C154.789917,502.646790 172.568237,512.867126 190.653320,523.286743 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M246.111847,398.195862 	C209.534485,419.230713 173.286148,440.104919 136.131393,461.501099 	C136.131393,413.288208 136.131393,366.470551 136.131393,318.132599 	C177.660904,342.058807 218.326828,365.487488 259.764221,389.360626 	C255.444778,393.477264 250.525467,395.161926 246.111847,398.195862 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M399.332825,771.000122 	C399.332977,779.754822 399.332977,788.009521 399.332977,797.836792 	C357.479462,773.692627 316.925812,750.298401 274.843384,726.022217 	C316.649658,701.854736 357.248199,678.385498 399.332672,654.057190 	C399.332672,693.855652 399.332672,732.177856 399.332825,771.000122 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M364.672455,662.736938 	C333.559052,680.670837 302.764893,698.421997 271.137085,716.653687 	C271.137085,668.562744 271.137085,621.650635 271.137085,573.487427 	C312.586700,597.407288 353.137726,620.808533 394.711456,644.799927 	C384.647125,651.848267 374.496155,656.685852 364.672455,662.736938 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M357.737427,326.821167 	C328.953278,343.444275 300.484131,359.878967 271.128601,376.825348 	C271.128601,328.790466 271.128601,281.990295 271.128601,233.664505 	C312.450500,257.499298 353.060242,280.923340 395.051483,305.144226 	C381.964600,312.744934 370.008484,319.688873 357.737427,326.821167 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M316.606995,201.582062 	C344.276062,185.623016 371.620636,169.834167 399.956787,153.472778 	C399.956787,201.512634 399.956787,248.439682 399.956787,296.613525 	C358.820312,272.866821 318.095551,249.357788 276.050323,225.086487 	C290.273224,216.837357 303.277893,209.294800 316.606995,201.582062 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M434.561646,561.518066 	C428.161255,557.440002 421.353302,554.673218 414.884247,549.292847 	C432.861572,538.888000 450.129211,528.893860 468.410828,518.312927 	C468.410828,539.640259 468.410828,559.683228 468.410828,581.018188 	C456.606018,574.221619 445.739899,567.965393 434.561646,561.518066 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M438.104126,388.057648 	C448.027527,382.322479 457.637848,376.776855 467.248169,371.231232 	C467.826874,371.396606 468.405609,371.561981 468.984344,371.727356 	C469.190735,391.715759 469.047241,411.707031 468.991791,431.697571 	C468.493195,432.010376 467.994598,432.323181 467.496002,432.635956 	C450.209015,422.679657 432.922028,412.723328 414.193939,401.937042 	C422.812592,396.936920 430.301819,392.592072 438.104126,388.057648 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M354.374054,366.728638 	C351.994690,364.980865 349.167053,364.438721 347.302216,361.236969 	C364.726776,351.175781 382.036011,341.181213 400.393494,330.581360 	C400.393494,351.741425 400.393494,371.750824 400.393494,393.040192 	C384.577484,384.002838 369.629761,375.461670 354.374054,366.728638 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M446.524292,519.578735 	C434.419983,526.564087 422.627502,533.356628 410.835022,540.149170 	C410.252411,540.004089 409.669800,539.859009 409.087189,539.713928 	C409.097595,519.659424 408.784271,499.608154 409.441742,478.172333 	C427.841461,488.779663 445.244720,498.812561 463.330902,509.239166 	C457.703735,513.774780 452.013092,516.177734 446.524292,519.578735 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M445.768555,579.196899 	C451.524872,582.535767 456.962585,585.693115 463.741821,589.629395 	C445.362823,600.261353 428.000916,610.304871 409.630127,620.932068 	C409.630127,599.739807 409.630127,579.759521 409.630127,558.420471 	C422.073242,565.574768 433.761627,572.295105 445.768555,579.196899 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M376.510620,424.482422 	C384.316620,420.003174 391.809479,415.714386 400.325378,410.840027 	C400.325378,431.744415 400.325378,451.637115 400.325378,473.003754 	C382.377014,462.699463 365.093384,452.776794 346.294678,441.984314 	C357.115570,435.719849 366.656525,430.196381 376.510620,424.482422 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M433.361633,380.429810 	C426.152618,384.543091 419.266754,388.483093 412.360291,392.434906 	C410.493958,388.716339 409.833862,340.332886 411.507324,330.797455 	C429.300385,341.014587 446.687744,350.998749 465.507965,361.805695 	C454.124207,368.405884 443.904449,374.331207 433.361633,380.429810 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M370.655701,574.593445 	C380.099579,569.446167 388.743713,563.577576 398.895660,558.871765 	C398.895660,579.608704 398.895660,599.472412 398.895660,620.868652 	C380.724487,610.403809 363.344177,600.394348 344.809967,589.720337 	C354.096985,584.278259 362.214600,579.521484 370.655701,574.593445 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M367.535980,385.407013 	C376.738037,390.748749 385.629913,395.896912 395.851227,401.814789 	C377.529480,412.400726 360.282867,422.365448 341.904449,432.984131 	C341.904449,411.738953 341.904449,391.791931 341.904449,371.018982 	C350.973846,375.285889 358.925720,380.577423 367.535980,385.407013 z"/><path fill="#000000" opacity="1.000000" stroke="none" 	d="M372.178070,563.233887 	C362.242371,568.971008 352.633789,574.545105 341.978455,580.726440 	C341.978455,559.660400 341.978455,539.633301 341.978455,518.534302 	C359.981415,528.917175 377.286346,538.897461 395.823120,549.588257 	C387.319672,554.504944 379.912415,558.787842 372.178070,563.233887 z"/></svg>)rawliteral", // SVG Logo
                        "WordClock Setup",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // Project Title
                        "",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Project Sub-title
                        "Lets give up the WiFi password",
                        // Project Information
                        "All rights reserved  me",                   // Footer
                                                                      // Text
                        "U did it!",                                  // Success Message
                        "This action will erase all stored settings", // Reset Confirmation Text
                        "",                                           // Input Field Text
                        0,                                            // Input Field Length
                        false,                                        // Show Input Field
                        true                                          // Show Reset Field
                    );
                    WiFiProvisioner provisioner(customCfg);
                    provisioner.startProvisioning();
                }
                else
                {
                    // If we just connected successfully, the WIFI_EVENT_CONNECTED event will
                    // be sent automatically by the WiFiEvent handler, which will trigger the sync.
                }
            }
            break;

            case WIFI_EVENT_CONNECTED:
            {
                Serial.printf("[WiFi Task] Event: Connected! IP: %s\n", WiFi.localIP().toString().c_str());

                SystemCommand cmd = {SystemCommandType::SHOW_WIFI_ANIMATION};
                xQueueSend(context->systemCommandQueue, &cmd, 0);
                vTaskDelay(pdMS_TO_TICKS(100));

                context->display.clearBuffer();
                context->display.setCursor(0, 0);
                context->display.setTextSize(1);
                context->display.setTextColor(EPD_RED);
                context->display.println("Status: WiFi Connected");
                context->display.printf("SSID: ");
                context->display.setTextColor(EPD_BLACK);
                context->display.printf("%s\n", WiFi.SSID().c_str());
                context->display.setTextColor(EPD_RED);
                context->display.printf("IP: ");
                context->display.setTextColor(EPD_BLACK);
                context->display.printf("%s\n", WiFi.localIP().toString().c_str());
                context->display.println("Syncing time...");
                xQueueSend(context->epdQueue, NULL, 0);

                if (getTimezoneAndSync(context))
                {
                    Serial.println("[WiFi Task] Time sync successful.");
                }
                else
                {
                    Serial.println("[WiFi Task] Time sync failed after all retries.");
                }
            }
            break;

            case CLEAR_WIFI:
            {
                WiFi.mode(WIFI_STA);
                WiFi.begin();
                Serial.println("[WiFi Task] Event: Clear WiFi credentials and reboot.");
                WiFi.disconnect(false, true);
                vTaskDelay(pdMS_TO_TICKS(1000));
                ESP.restart();
            }
            break;
            }
        }
    }
}

// --- E-Paper Display Task ---
void task_epd(void *pvParameters)
{
    Serial.println("EPD Task started.");
    auto *context = static_cast<AppContext *>(pvParameters);

    context->display.begin();
    context->display.clearBuffer();
    context->display.setRotation(2);

    for (;;)
    {
        if (xQueueReceive(context->epdQueue, NULL, portMAX_DELAY))
        {
            Serial.println("[EPD] Updating physical display.");
            context->display.display();
        }
    }
}

// --- Helper Function Implementations ---

static bool initializeFromRtc(AppContext *context)
{
    if (!context->rtc.begin())
    {
        Serial.println("[ERROR] Couldn't find RTC! Clock will not keep time without power.");
        return false;
    }

    if (context->rtc.lostPower())
    {
        Serial.println("[WARN] RTC lost power. Setting to compile time as fallback.");
        context->rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
    }

    DateTime rtcnow = context->rtc.now();
    if (rtcnow.year() < 2024)
    {
        Serial.printf("[WARN] RTC has an invalid time (Year: %d). Waiting for WiFi sync.\n", rtcnow.year());
        return false;
    }

    struct timeval tv = {.tv_sec = static_cast<time_t>(rtcnow.unixtime()), .tv_usec = 0};
    settimeofday(&tv, NULL);
    Serial.println("System time initialized from hardware RTC.");

    String tz_string = context->preferences.getString(NVS_TZ_KEY, "");
    if (tz_string.length() > 0)
    {
        strncpy(context->time_zone, tz_string.c_str(), sizeof(context->time_zone) - 1);
        setenv("TZ", tz_string.c_str(), 1);
        tzset();
        Serial.printf("Timezone set from NVS: %s\n", context->time_zone);
    }
    else
    {
        Serial.println("Timezone not yet known, defaulting to UTC for now.");
    }

    SystemCommand cmd = {SystemCommandType::START_CLOCK_DISPLAY};
    xQueueSend(context->systemCommandQueue, &cmd, 0);
    return true;
}

static bool getTimezoneAndSync(AppContext *context)
{
    WiFiClientSecure client;
    client.setCACert(root_ca_worldtimeapi);
    HTTPClient http;
    bool tz_success = false;

    // --- Retry loop for fetching timezone ---
    for (int i = 0; i < MAX_SYNC_RETRIES; ++i)
    {
        Serial.printf("[Time Sync] Fetching timezone, attempt %d/%d...\n", i + 1, MAX_SYNC_RETRIES);
        if (http.begin(client, TIME_API_URL))
        {
            http.setConnectTimeout(8000);
            int httpCode = http.GET();

            if (httpCode == HTTP_CODE_OK)
            {
                JsonDocument doc;
                if (deserializeJson(doc, http.getStream()).code() == DeserializationError::Ok)
                {
                    const char *tz_iana = doc["timezone"];
                    if (tz_iana)
                    {
                        const char *tz_posix = TzDbLookup::getPosix(tz_iana);
                        strncpy(context->time_zone, tz_posix, sizeof(context->time_zone) - 1);
                        Serial.printf("[Time Sync] Fetched Timezone: %s (POSIX: %s)\n", tz_iana, context->time_zone);
                        context->preferences.putString(NVS_TZ_KEY, context->time_zone);
                        tz_success = true;
                        http.end();
                        break; // Exit retry loop on success
                    }
                }
            }
            http.end();
        }
        Serial.println("[Time Sync] Failed to fetch timezone on this attempt.");
        vTaskDelay(pdMS_TO_TICKS(RETRY_DELAY_MS));
    }

    if (!tz_success)
    {
        Serial.println("[Time Sync] Failed to fetch timezone after all retries.");
        context->display.setTextColor(EPD_RED);
        context->display.println("Timezone Fetch Failed.");
        xQueueSend(context->epdQueue, NULL, 0);
        return false;
    }

    // --- Retry loop for NTP sync ---
    for (int i = 0; i < MAX_SYNC_RETRIES; ++i)
    {
        Serial.printf("[Time Sync] Syncing with NTP server, attempt %d/%d...\n", i + 1, MAX_SYNC_RETRIES);
        configTzTime(context->time_zone, NTP_SERVER_1, NTP_SERVER_2);

        struct tm timeinfo;
        if (getLocalTime(&timeinfo, 15000))
        { // 15-second timeout for NTP
            Serial.println("[Time Sync] System time synced via NTP.");

            time_t now_utc;
            time(&now_utc);
            context->rtc.adjust(DateTime(now_utc));
            Serial.println("[Time Sync] RTC has been updated with correct UTC time.");

            setenv("TZ", context->time_zone, 1);
            tzset();
            char time_buf[64];
            localtime_r(&now_utc, &timeinfo);
            strftime(time_buf, sizeof(time_buf), "%b %d %H:%M:%S %Z", &timeinfo);
            context->display.println("Sync successful!");
            context->display.printf("Last sync:\n%s\n", time_buf);
            xQueueSend(context->epdQueue, NULL, 0);

            if (!context->time_is_valid)
            {
                SystemCommand cmd = {SystemCommandType::START_CLOCK_DISPLAY};
                xQueueSend(context->systemCommandQueue, &cmd, 0);
            }
            return true; // Return true on success
        }
        Serial.println("[Time Sync] Failed to get local time from NTP server on this attempt.");
        vTaskDelay(pdMS_TO_TICKS(RETRY_DELAY_MS));
    }

    Serial.println("[Time Sync] Failed to sync NTP after all retries.");
    context->display.setTextColor(EPD_RED);
    context->display.println("NTP Sync Failed.");
    xQueueSend(context->epdQueue, NULL, 0);
    return false;
}
